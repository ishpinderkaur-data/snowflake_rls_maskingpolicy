CREATE OR REPLACE DATABASE GOT_DB;
CREATE OR REPLACE SCHEMA GOT_DB.GOT_SCHEMA;
CREATE OR REPLACE TABLE GOT_DB.GOT_SCHEMA.GOT_CHARACTERS (
  ID INT,
  CHARACTER_NAME STRING,
  TRUE_IDENTITY STRING,
  HOUSE STRING,
  ROLE_IN_REALM STRING
);

INSERT INTO GOT_DB.GOT_SCHEMA.GOT_CHARACTERS VALUES
  (1, 'Jon Snow', 'Aegon Targaryen', 'Stark', 'King in the North'),
  (2, 'Arya Stark', 'No One', 'Stark', 'Faceless Assassin'),
  (3, 'Daenerys Stormborn', 'Daenerys Targaryen', 'Targaryen', 'Dragon Queen'),
  (4, 'Tyrion Lannister', 'Tyrion Lannister', 'Lannister', 'Hand of the Queen'),
  (5, 'Jaime Lannister', 'Jaime Lannister', 'Lannister', 'Kingslayer');

CREATE OR REPLACE ROLE ROLE_NORTH_WATCH;
CREATE OR REPLACE ROLE ROLE_COMMONER;
CREATE OR REPLACE ROLE ROLE_SMALL_COUNCIL;

GRANT USAGE ON DATABASE GOT_DB TO ROLE ROLE_NORTH_WATCH;
GRANT USAGE ON SCHEMA GOT_DB.GOT_SCHEMA TO ROLE ROLE_NORTH_WATCH;
GRANT SELECT ON GOT_DB.GOT_SCHEMA.GOT_CHARACTERS TO ROLE ROLE_NORTH_WATCH;

GRANT USAGE ON DATABASE GOT_DB TO ROLE ROLE_COMMONER;
GRANT USAGE ON SCHEMA GOT_DB.GOT_SCHEMA TO ROLE ROLE_COMMONER;
GRANT SELECT ON GOT_DB.GOT_SCHEMA.GOT_CHARACTERS TO ROLE ROLE_COMMONER;

GRANT USAGE ON DATABASE GOT_DB TO ROLE ROLE_SMALL_COUNCIL;
GRANT USAGE ON SCHEMA GOT_DB.GOT_SCHEMA TO ROLE ROLE_SMALL_COUNCIL;
GRANT SELECT ON GOT_DB.GOT_SCHEMA.GOT_CHARACTERS TO ROLE ROLE_SMALL_COUNCIL;

GRANT ROLE ROLE_NORTH_WATCH TO user ISHPINDERKAUR;
GRANT ROLE ROLE_COMMONER TO user ISHPINDERKAUR;
GRANT ROLE ROLE_SMALL_COUNCIL TO user ISHPINDERKAUR;

SELECT
*
FROM GOT_DB.GOT_SCHEMA.GOT_CHARACTERS;
--MAPPING TABLE LOOKUP
CREATE OR REPLACE TABLE GOT_DB.GOT_SCHEMA.GOT_ACCESS_CONTROL(
HOUSE varchar,
ROLE_ALLOWED varchar
);

-- INSERT VALUES INTO THIS TABLE

INSERT INTO GOT_DB.GOT_SCHEMA.GOT_ACCESS_CONTROL(HOUSE,ROLE_ALLOWED) VALUES
('Stark','ROLE_NORTH_WATCH');

SELECT * FROM GOT_DB.GOT_SCHEMA.GOT_ACCESS_CONTROL;
--initially mixed up teh roles and house , hence the delete statement, dont get confused.
--DELETE FROM GOT_DB.GOT_SCHEMA.GOT_ACCESS_CONTROL
--WHERE ROLE_ALLOWED='Stark';


--- rOLE ACCESS POLICY
CREATE OR REPLACE ROW ACCESS POLICY GOT_DB.GOT_SCHEMA.GOT_RLS
AS (house VARCHAR) RETURNS BOOLEAN ->
CURRENT_ROLE() IN ('ACCOUNTADMIN','ROLE_SMALL_COUNCIL','ROLE_COMMONER')
OR 
EXISTS(SELECT 1
FROM GOT_DB.GOT_SCHEMA.GOT_ACCESS_CONTROL ac
WHERE CURRENT_ROLE()=ac.ROLE_ALLOWED
AND house=ac.HOUSE);


-----apply on table
ALTER TABLE GOT_DB.GOT_SCHEMA.GOT_CHARACTERS
ADD ROW ACCESS POLICY GOT_DB.GOT_SCHEMA.GOT_RLS ON (HOUSE);

USE ROLE ROLE_NORTH_WATCH;

USE ROLE ACCOUNTADMIN;


---CREATING MASKING POLICY
CREATE OR REPLACE MASKING POLICY GOT_DB.GOT_SCHEMA.GOT_MASK AS (VAL STRING) RETURNS
STRING ->
CASE 
WHEN CURRENT_ROLE() IN ('ACCOUNTADMIN','ROLE_SMALL_COUNCIL','ROLE_NORTH_WATCH') THEN VAL
ELSE SHA2(VAL)
END;


ALTER TABLE GOT_DB.GOT_SCHEMA.GOT_CHARACTERS MODIFY COLUMN TRUE_IDENTITY
SET MASKING POLICY GOT_DB.GOT_SCHEMA.GOT_MASK;

USE ROLE ROLE_COMMONER;
